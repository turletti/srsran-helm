apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "srsran-ue.fullname" . }}-{{ .Release.Name }}-ue-config
  labels:
    {{- include "srsran-ue.labels" . | nindent 4 }}
data:
  start_ue.sh: |
    #!/bin/bash

    echo "--- Starting UE Configuration Script ---"

    # 1. Generate the configuration file using the Python script
    python3 /srsran/config/generate_ue_conf.py $1 /tmp/

    # 2. Start srsUE in the background
    echo "Starting srsUE process..."
    /opt/srsRAN_4G/build/srsue/src/srsue /tmp/ue_$1.conf > /proc/1/fd/1 2>&1 &
    UE_PID=$!

    # 3. Wait for the tun_srsue interface to be created and assigned an IP
    # Timeout is set to 100 seconds (50 iterations * 2s)
    echo "Waiting for tun_srsue interface to come up..."
    for i in {1..50}; do
      if ip addr show tun_srsue > /dev/null 2>&1; then
        UE_IP=$(ip addr show tun_srsue | grep 'inet ' | awk '{print $2}')
        if [ ! -z "$UE_IP" ]; then
          echo "âœ… Interface tun_srsue is UP with IP: $UE_IP"
          
          # --- APPLY NETWORK SETTINGS ---
          echo "Applying network configuration changes..."

          # Set MTU to 1400 to avoid fragmentation (standard for 5G tunnels)
          ip link set dev tun_srsue mtu 1400
          echo "Current MTU: $(cat /sys/class/net/tun_srsue/mtu)"

          # Change routes from /24 to /16 to broaden the reach
          # We check if the /24 route exists before deleting and replacing it
          if ip route show 12.1.0.0/24 dev tun_srsue > /dev/null 2>&1; then
            ip route del 12.1.0.0/24 dev tun_srsue
            ip route add 12.1.0.0/16 dev tun_srsue
            echo "Route 12.1.0.0 modified to /16"
          fi

          if ip route show 14.1.0.0/24 dev tun_srsue > /dev/null 2>&1; then
            ip route del 14.1.0.0/24 dev tun_srsue
            ip route add 14.1.0.0/16 dev tun_srsue
            echo "Route 14.1.0.0 modified to /16"
          fi

          echo "--- Final Routing Table ---"
          ip route
          break
        fi
      fi
      sleep 2
    done

    # Maintain the container alive as long as srsUE is running
    wait $UE_PID

  generate_ue_conf.py: |
    #!/usr/bin/env python3
    import argparse
    import os

    UE_TEMPLATE = """[rf]
    freq_offset = 0
    tx_gain = 80
    rx_gain = 40
    srate = 23.04e6
    nof_antennas = 1

    device_name = zmq
    device_args = tx_port={tx_port},rx_port={rx_port},base_srate=23.04e6

    [rat.eutra]
    dl_earfcn = 2850
    nof_carriers = 0

    [rat.nr]
    bands = 3
    nof_carriers = 1
    max_nof_prb = 106
    nof_prb = 106

    [log]
    all_level = warning
    phy_lib_level = none
    all_hex_limit = 32
    filename = {log_file}
    file_max_size = 1000

    [usim]
    mode = soft
    algo = milenage
    opc  = {opc}
    k    = {k}
    imsi = {imsi}
    imei = 356938035643803

    [rrc]
    release = 15
    ue_category = 4

    [nas]
    apn = {apn}
    apn_protocol = ipv4

    [gw]
    # netns removed so the tun interface appears in the pod's network namespace
    ip_devname = tun_srsue
    ip_netmask = 255.255.255.0

    [gui]
    enable = false
    """

    def generate_ue_config(ue_number: int, output_directory: str) -> str:
        os.makedirs(output_directory, exist_ok=True)
        # Values are injected by Helm during deployment
        cfg = UE_TEMPLATE.format(
            tx_port=f"tcp://{{ .Values.gnbIp }}:{{ .Values.zmq.tx_port }}",
            rx_port=f"tcp://{{ .Values.gnbIp }}:{{ .Values.zmq.rx_port }}",
            log_file=os.path.join(output_directory, f"ue{ue_number}.log"),
            opc="{{ .Values.opc }}",
            k="{{ .Values.k }}",
            imsi="{{ .Values.imsi }}",
            apn="{{ .Values.apn }}",
        )
        path = os.path.join(output_directory, f"ue_{ue_number}.conf")
        with open(path, "w") as f:
            f.write(cfg)
        print(f"Wrote {path}")
        return path

    if __name__ == '__main__':
        parser = argparse.ArgumentParser(description='Generate srsUE configuration.')
        parser.add_argument('ue_number', type=int)
        parser.add_argument('output_directory', type=str)
        args = parser.parse_args()
        generate_ue_config(args.ue_number, args.output_directory)
