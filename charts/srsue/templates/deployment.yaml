apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "srsran-ue.fullname" . }}-{{ .Release.Name }}
  labels:
    {{- include "srsran-ue.labels" . | nindent 4 }}
spec:
  selector:
    matchLabels:
      {{- include "srsran-ue.selectorLabels" . | nindent 6 }}
  replicas: 1
  template:
    metadata:
      labels:
        {{- include "srsran-ue.selectorLabels" . | nindent 8 }}
      annotations:
        k8s.v1.cni.cncf.io/networks: >-
          [{ "name": "n3network", "interface": "n3", "ips": [ "{{ .Values.ueIp }}/24" ] }]
    spec:
      containers:
        - name: ue
          image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          securityContext:
            privileged: true
            capabilities:
              add: ["NET_ADMIN", "SYS_NICE", "IPC_LOCK", "CAP_NET_ADMIN"]
          command: ["/bin/bash", "-c", "--"]
          args:
            - |
              mkdir -p /dev/net
              if [ ! -c /dev/net/tun ]; then mknod /dev/net/tun c 10 200; fi
              apt update && apt install -y iputils-ping iperf3 tmux
              /bin/bash /srsran/config/start_ue.sh 1
          env:
            - name: PATH
              value: "/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/srsran/config"
          volumeMounts:
            - name: ue-config
              mountPath: /srsran/config
      dnsPolicy: ClusterFirst
      restartPolicy: Always
      {{- if .Values.nodeName }}
      nodeName: {{ .Values.nodeName }}
      {{- end }}
      volumes:
        - name: ue-config
          configMap:
            name: {{ include "srsran-ue.fullname" . }}-{{ .Release.Name }}-ue-config
            defaultMode: 0755
